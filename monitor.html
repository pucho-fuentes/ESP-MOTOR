<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Monitor IMU ‚Äì ESP32</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #0f172a;
        color: #e5e7eb;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        margin-bottom: 10px;
    }

    .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .card {
        background: #020617;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 15px rgba(0,0,0,.4);
    }

    .values {
        display: flex;
        justify-content: space-around;
        font-size: 1.3em;
        margin-top: 10px;
    }

    .status {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        border-radius: 10px;
        background: #022c22;
        transition: .3s;
    }

    .status.alert {
        background: #450a0a;
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: .6; }
        100% { opacity: 1; }
    }

    .indicator {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: lime;
        margin: auto;
    }

    .indicator.alert {
        background: red;
    }

    .footer {
        margin-top: 20px;
        text-align: center;
    }

    button {
        background: #2563eb;
        border: none;
        color: white;
        padding: 12px 20px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
    }

    button:hover {
        background: #1d4ed8;
    }

</style>
</head>

<body>

<h1>üì° Monitor de Vibraciones IMU</h1>

<div class="container">

    <div class="card">
        <h2>üìà Aceleraciones (m/s¬≤)</h2>
        <canvas id="imuChart"></canvas>

        <div class="values">
            <div>AX: <span id="valueAX">0</span></div>
            <div>AY: <span id="valueAY">0</span></div>
            <div>AZ: <span id="valueAZ">0</span></div>
        </div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Estado del Motor</h2>

        <div class="status" id="statusPanel">
            <div id="statusIcon" style="font-size:40px;">‚úÖ</div>
            <h3 id="statusText">Estado Normal</h3>
            <p id="statusDescription">Motor operando correctamente</p>
            <div class="indicator" id="vibrationIndicator"></div>
        </div>

        <p style="text-align:center;margin-top:15px;">
            üì¶ Muestras: <span id="sampleCount">0</span><br>
            üö® Alertas: <span id="alertCount">0</span>
        </p>
    </div>

</div>

<div class="footer">
    <button onclick="downloadCSV()">‚¨áÔ∏è Descargar registros CSV</button>
</div>

<script>
let sampleCount = 0;
let alertCount = 0;

// CHART
const ctx = document.getElementById('imuChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [],
        datasets: [
            { label: 'AX', data: [], borderWidth: 2 },
            { label: 'AY', data: [], borderWidth: 2 },
            { label: 'AZ', data: [], borderWidth: 2 }
        ]
    },
    options: {
        responsive: true,
        animation: false,
        scales: {
            y: {
                title: {
                    display: true,
                    text: 'm/s¬≤'
                }
            }
        }
    }
});

// SOCKET.IO
const socket = io();

socket.on("connect", () => {
    console.log("üü¢ Conectado al servidor");
});

socket.on("imu_update", data => {

    sampleCount++;
    document.getElementById("sampleCount").textContent = sampleCount;

    document.getElementById("valueAX").textContent = data.ax.toFixed(2);
    document.getElementById("valueAY").textContent = data.ay.toFixed(2);
    document.getElementById("valueAZ").textContent = data.az.toFixed(2);

    const time = new Date().toLocaleTimeString();

    chart.data.labels.push(time);
    chart.data.datasets[0].data.push(data.ax);
    chart.data.datasets[1].data.push(data.ay);
    chart.data.datasets[2].data.push(data.az);

    if (chart.data.labels.length > 60) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(d => d.data.shift());
    }

    chart.update("none");

    const statusPanel = document.getElementById("statusPanel");
    const indicator = document.getElementById("vibrationIndicator");

    if (data.alert) {
        alertCount++;
        document.getElementById("alertCount").textContent = alertCount;

        statusPanel.classList.add("alert");
        indicator.classList.add("alert");

        document.getElementById("statusIcon").textContent = "üö®";
        document.getElementById("statusText").textContent = "VIBRACI√ìN EXCESIVA";
        document.getElementById("statusDescription").textContent = "Revisar motor inmediatamente";
    } else {
        statusPanel.classList.remove("alert");
        indicator.classList.remove("alert");

        document.getElementById("statusIcon").textContent = "‚úÖ";
        document.getElementById("statusText").textContent = "Estado Normal";
        document.getElementById("statusDescription").textContent = "Motor operando correctamente";
    }
});

// DESCARGA CSV
function downloadCSV() {
    window.location.href = "/api/csv";
}
</script>

</body>
</html>
